name: 'Claude Task Handler'

on:
  issues:
    types: [opened, edited]

jobs:
  handle-claude-task:
    name: 'Process Claude Task'
    runs-on: ubuntu-latest
    if: contains(github.event.issue.body, '@claude')

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Set up Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 'Extract task information'
        id: extract
        run: |
          # Issue æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "ISSUE_BODY<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "USER_LOGIN=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT

          # ãƒ­ã‚°å‡ºåŠ›
          echo "âœ… Issue æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã—ãŸ"
          echo "  - Issue Number: ${{ github.event.issue.number }}"
          echo "  - Title: ${{ github.event.issue.title }}"

      - name: 'Detect @claude mention'
        id: detect
        run: |
          if echo "${{ steps.extract.outputs.ISSUE_BODY }}" | grep -q "@claude"; then
            echo "CLAUDE_MENTIONED=true" >> $GITHUB_OUTPUT
            echo "âœ… @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          else
            echo "CLAUDE_MENTIONED=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: 'Create Claude task message'
        if: steps.detect.outputs.CLAUDE_MENTIONED == 'true'
        id: message
        run: |
          # Claude ã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          TASK_MESSAGE="GitHub Issue #${{ steps.extract.outputs.ISSUE_NUMBER }} ã‹ã‚‰é€ã‚‰ã‚ŒãŸã‚¿ã‚¹ã‚¯:

ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘
${{ steps.extract.outputs.ISSUE_TITLE }}

ã€æœ¬æ–‡ã€‘
${{ steps.extract.outputs.ISSUE_BODY }}"

          echo "TASK_MESSAGE<<EOF" >> $GITHUB_OUTPUT
          echo "$TASK_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 'Log task details'
        if: steps.detect.outputs.CLAUDE_MENTIONED == 'true'
        run: |
          echo "ğŸ“‹ ã‚¿ã‚¹ã‚¯è©³ç´°:"
          echo "  - Issue Number: ${{ steps.extract.outputs.ISSUE_NUMBER }}"
          echo "  - Title: ${{ steps.extract.outputs.ISSUE_TITLE }}"
          echo "  - User: ${{ steps.extract.outputs.USER_LOGIN }}"
          echo ""
          echo "ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å…ˆé ­ 200 æ–‡å­—):"
          echo "${{ steps.message.outputs.TASK_MESSAGE }}" | head -c 200
          echo "..."

      - name: 'Send to Claude Code Action'
        if: steps.detect.outputs.CLAUDE_MENTIONED == 'true'
        run: |
          echo "âœ… Claude Code Action ã«ã‚¿ã‚¹ã‚¯ã‚’é€ä¿¡ã—ã¾ã™"
          echo ""
          echo "ğŸ“¤ é€ä¿¡å†…å®¹:"
          echo "  - Issue URL: ${{ github.event.issue.html_url }}"
          echo "  - Issue Number: ${{ steps.extract.outputs.ISSUE_NUMBER }}"
          echo ""
          echo "ğŸ’¡ Claude ã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™:"
          echo "  1. Issue æœ¬æ–‡ã‚’ãƒ‘ãƒ¼ã‚¹"
          echo "  2. A2A é€šä¿¡ã§ã‚¿ã‚¹ã‚¯é€ä¿¡"
          echo "  3. å‡¦ç†çµæœã‚’ Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆ"
          echo ""
          echo "ğŸ”” å‡¦ç†ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã™..."

      - name: 'Add processing comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `â³ **å‡¦ç†ä¸­**

ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™...

- ğŸ”§ **ã‚·ã‚¹ãƒ†ãƒ **: Claude Code A2A Communication
- ğŸ‘¤ **é€ä¿¡è€…**: GitHub Actions
- ğŸ“… **é–‹å§‹æ™‚åˆ»**: ${new Date().toISOString()}

å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
            })

      - name: 'Set up Python for GitHub Action Handler'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 'Install dependencies'
        run: |
          pip install PyGithub requests

      - name: 'Run GitHub Action Handler'
        if: steps.detect.outputs.CLAUDE_MENTIONED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_ISSUE_NUMBER: ${{ steps.extract.outputs.ISSUE_NUMBER }}
          GITHUB_ISSUE_TITLE: ${{ steps.extract.outputs.ISSUE_TITLE }}
          GITHUB_ISSUE_BODY: ${{ steps.extract.outputs.ISSUE_BODY }}
          ZMQ_BROKER_URL: ${{ secrets.ZMQ_BROKER_URL || 'tcp://localhost:5555' }}
        run: |
          cd /home/planj/Claude-Code-Communication
          python3 integrations/github_action_handler.py

      - name: 'Verify workflow execution'
        run: |
          echo "âœ… GitHub Actions Workflow å®Ÿè¡Œå®Œäº†"
          echo ""
          echo "ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼:"
          echo "  - Workflow: Claude Task Handler"
          echo "  - Trigger: Issue created/edited with @claude"
          echo "  - Status: SUCCESS"
          echo ""
          echo "ğŸ”— å‚è€ƒ:"
          echo "  - Issue: ${{ github.event.issue.html_url }}"
          echo "  - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
