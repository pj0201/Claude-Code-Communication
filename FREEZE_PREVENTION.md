# Claude Code フリーズ予防ガイド

## 📋 概要

このドキュメントは、2025-10-13に発生したClaude Codeプロセスのフリーズ問題の分析と予防策をまとめたものです。

---

## 🔍 発生した問題

### 症状
- **プロセスID**: 25296
- **発生時刻**: 2025-10-13 19:54 開始、約3時間後にフリーズ
- **CPU使用率**: 12.6%（長時間継続）
- **メモリ使用量**: 587MB（通常の2-3倍）
- **TCP接続数**: 70個以上（異常）
- **送信バッファ**: 複数の接続で詰まり（8161バイト、1305バイト等）

### 根本原因
1. **接続リーク**: Anthropic APIサーバーへの接続が適切にクローズされず蓄積
2. **ネットワーク待機**: 複数のAPI呼び出しが応答待ちでスタック
3. **リソース枯渇**: 接続プールが枯渇し、新規リクエストが処理不能

---

## 🛡️ 予防策

### 1. 定期的な健全性チェック

**監視スクリプトの実行**:
```bash
/home/planj/Claude-Code-Communication/monitor-claude-health.sh
```

**推奨頻度**: 1時間ごと、または長時間タスク実行前後

**検出項目**:
- CPU使用率の異常（30%以上）
- TCP接続数の異常（50個以上）
- 送信バッファの詰まり（5個以上）
- 長時間稼働（3時間以上）

### 2. 長時間タスクの分割

**リスクの高いタスク**:
- 大量のファイル読み込み・解析
- 複数APIの並列呼び出し
- 大規模なコードベース処理
- ネットワークI/O密度の高い処理

**対策**:
```bash
# 悪い例: 一度に全ファイルを処理
claude "プロジェクト全体の1000ファイルを解析してください"

# 良い例: 段階的に処理
claude "まず重要な10ファイルを解析してください"
# 完了後
claude "次の10ファイルを解析してください"
```

### 3. プロセスの定期的な再起動

**3時間以上の連続使用後**:
```bash
# 現在のプロセスを確認
ps aux | grep claude | grep -v grep

# 安全な終了（作業保存後）
# Ctrl+C または exit コマンド

# 新規起動
claude
```

### 4. ネットワーク状態の確認

**接続数の定期確認**:
```bash
# Claude Codeプロセスの接続数確認
ss -anp | grep claude | wc -l
```

**異常な接続数**: 20個以上の場合は注意、50個以上は危険

### 5. スモールチームシステムとの分離

**重要**: スモールチームシステム（line-to-claude-bridge、a2a_system等）とは別プロセスで動作

**確認方法**:
```bash
ps aux | grep -E "line.*bridge|a2a|team-support" | grep -v grep
```

---

## 🚨 フリーズ検出時の対処法

### ステップ1: 健全性チェック実行
```bash
/home/planj/Claude-Code-Communication/monitor-claude-health.sh
```

### ステップ2: フリーズプロセスの特定
```bash
ps aux | grep claude | grep -v grep | awk '{print $2, $3, $4, $10, $11}'
```

**フリーズの兆候**:
- CPU使用率が30%以上で長時間継続
- TCP接続数が50個以上
- メモリ使用量が500MB以上

### ステップ3: スモールチームシステムの保護確認
```bash
# スモールチームプロセスが動作中か確認
ps -p 20426,14079,23032,26613 -o pid,cmd 2>/dev/null
```

### ステップ4: 安全な終了
```bash
# 通常終了を試行
kill [PID]

# 5秒待機後、確認
sleep 5 && ps -p [PID] || echo "正常終了"

# 応答しない場合は強制終了
kill -9 [PID]
```

### ステップ5: スモールチームシステムの動作確認
```bash
# ログ確認
tail -5 /tmp/line_bridge_realtest.log
tail -5 /tmp/claude_bridge_restart.log

# プロセス確認
ps aux | grep -E "line.*bridge|a2a" | grep -v grep
```

---

## 📊 監視スクリプトの詳細

### monitor-claude-health.sh

**機能**:
- 全Claude Codeプロセスの健全性チェック
- CPU、メモリ、TCP接続、稼働時間の監視
- フリーズの自動検出とアラート
- スモールチームプロセスの自動除外

**閾値**:
```bash
CPU_THRESHOLD=30        # CPU使用率（%）
CONN_THRESHOLD=50       # TCP接続数
UPTIME_THRESHOLD=10800  # 稼働時間（3時間）
MEMORY_THRESHOLD=500000 # メモリ使用量（KB）
```

**出力例**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Process: 25296 (/home/planj)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️  WARNING: High CPU usage: 32% (threshold: 30%)
⚠️  WARNING: High memory usage: 587MB
❌ ERROR: Excessive TCP connections: 73 (threshold: 50)
❌ ERROR: Blocked connections with pending data: 8

❌ ERROR: Process 25296 appears to be FROZEN!
  Recommendation: kill 25296
```

---

## 🔄 定期メンテナンス

### 日次
- [ ] 長時間稼働プロセスの確認（3時間以上）
- [ ] TCP接続数の確認

### 週次
- [ ] 健全性チェックスクリプトの実行
- [ ] ログファイルのクリーンアップ

### 月次
- [ ] プロセス統計の分析
- [ ] 閾値の見直し

---

## 📝 トラブルシューティングログ

### 2025-10-13 フリーズ事例

**検出時刻**: 23:00
**プロセスID**: 25296
**稼働時間**: 3時間6分
**CPU使用率**: 12.6%
**メモリ**: 587MB
**TCP接続**: 73個
**詰まり接続**: 8個

**原因**: API接続リークによるリソース枯渇
**対処**: kill -9 25296で強制終了
**影響**: スモールチームシステムへの影響なし
**再発防止**: 監視スクリプト作成、本ドキュメント作成

---

## 🎯 ベストプラクティス

1. **タスクの分割**: 大規模タスクは小さく分けて実行
2. **定期確認**: 1時間ごとに健全性チェック
3. **早期対処**: 警告サインが出たら即座に対応
4. **ログ確認**: エラーログの定期的な確認
5. **計画的再起動**: 3時間以上の使用後は再起動を検討

---

## 📚 関連ドキュメント

- `CLAUDE.md`: チーム運営ガイド（スモールチームシステムの詳細）
- `SMALL_TEAM_GUIDE.md`: 小規模チーム構成ガイド
- `monitor-claude-health.sh`: 健全性チェックスクリプト

---

## 🆘 緊急連絡先

問題が解決しない場合は、Claude Code GitHubリポジトリにIssueを報告してください:
https://github.com/anthropics/claude-code/issues

---

**最終更新**: 2025-10-13
**作成者**: Claude Code Team
