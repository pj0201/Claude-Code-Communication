# 予約メール自動取り込みシステムの設計相談

## 相談の背景

宿泊アプリ開発において、API連携できない予約サイトからの予約情報を自動取り込みするシステムが必要です。

## 現状の課題

### API連携の制限
- **Booking.com**: チャネルマネージャー経由のみ（直接連携不可）
- **Airbnb**: 認定パートナー経由のみ（新規API申請停止中）
- その他の小規模OTAサイト: API提供なし

### 必要な機能
1. 予約サイトから送信される予約確定メールを受信
2. メールから予約データ（宿泊者名、日程、部屋タイプ、料金等）を自動抽出
3. アプリ内のデータベースに自動反映
4. エラー時の通知・手動修正機能

## 提案する基本フロー

```
[予約サイト] → [予約確定メール送信]
       ↓
[メールシステム（Gmail/Outlook等）]
       ↓
    [自動転送 or API取得]
       ↓
[メール解析サービス/Lambda関数]
       ↓
    [データ抽出・構造化]
       ↓
[宿泊アプリ データベース]
       ↓
    [管理画面で確認・承認]
```

## GPT-5への相談事項

### 1. メール受信方法の選択
**質問**: 以下のどの方式が最も簡素で信頼性が高いでしょうか？

**選択肢**:
- **A. メール転送ルール + Webhook受信**
  - Gmail/Outlookの自動転送機能を使用
  - 専用メールアドレスに転送 → Webhook APIで受信

- **B. IMAP/POP3接続**
  - 定期的にメールボックスをポーリング
  - 未読メールを取得・処理

- **C. メールサービスAPI**
  - Gmail API / Microsoft Graph API を使用
  - OAuth認証でアクセス

- **D. サードパーティメール解析サービス**
  - Zapier / Make (Integromat) / Mailparser等
  - ノーコードでメール解析

**判断基準**:
- 実装の簡素さ
- メンテナンス性
- エラー発生率
- コスト
- セキュリティ

### 2. メール解析方法

**質問**: 各予約サイトのメールフォーマットが異なる場合、どのように対処すべきでしょうか？

**考えられるアプローチ**:
- **パターンマッチング**: 正規表現で各サイトのフォーマットに対応
- **AI/LLM解析**: GPT-4/Claude等で自然言語解析
- **HTMLパース**: メールのHTML構造を解析
- **テンプレート登録**: 各サイトごとにテンプレートを事前定義

**期待する精度**: 95%以上の自動抽出成功率

### 3. エラーハンドリング

**質問**: 以下のエラーケースにどう対応すべきでしょうか？

- メール解析失敗（フォーマット変更等）
- 重複予約の検出
- 必須項目の欠落
- 日付フォーマットの違い

**求める仕組み**:
- 自動リトライの要否
- 管理者への通知方法
- 手動確認フロー
- ログ・監査証跡

### 4. データベース反映

**質問**: データベースへの反映タイミングはどうすべきでしょうか？

**選択肢**:
- **即時反映**: メール解析後すぐにDBに登録
- **承認後反映**: 管理画面で確認・承認後に登録
- **ハイブリッド**: 高信頼度は自動、低信頼度は手動確認

### 5. 既存システムとの統合

**現在の技術スタック**:
- フロントエンド: React + TypeScript + Vite
- バックエンド: 未実装（Supabase想定）
- ホスティング: 未定

**質問**:
- サーバーレス（AWS Lambda / Cloudflare Workers等）が適切か？
- 専用バックエンドサーバーが必要か？
- Supabase Edge Functionsで実装可能か？

## 期待する回答

1. **最もシンプルで堅牢な方式の提案**
2. **各方式のメリット・デメリット比較**
3. **実装時の注意点・ベストプラクティス**
4. **推奨する技術スタック・ツール**
5. **段階的な実装ロードマップ**

## 補足情報

### 想定する予約サイト
- Booking.com
- Airbnb
- 楽天トラベル（API連携も可能だが、メール取り込みもバックアップとして）
- じゃらん（同上）
- その他小規模OTA

### 予約メールに含まれる典型的な情報
- 予約番号
- 宿泊者名（漢字・カナ・ローマ字）
- チェックイン日時
- チェックアウト日時
- 宿泊人数
- 部屋タイプ
- 料金
- 連絡先（メール・電話）
- 特記事項

### 非機能要件
- 24時間365日稼働
- メール受信後30分以内にDB反映
- 99%以上の稼働率
- セキュリティ（個人情報保護）

---

## GPT-5へのお願い

上記の要件を踏まえ、**最も実用的で保守しやすいアーキテクチャ**を提案してください。

特に重視する点:
1. **シンプルさ**: 複雑な仕組みは避けたい
2. **信頼性**: メール取りこぼしやデータ欠損を防ぐ
3. **拡張性**: 将来的に予約サイト追加に対応
4. **コスト効率**: 過剰なインフラ投資は避けたい

よろしくお願いします！

---

**作成者**: Claude Code Worker3
**作成日**: 2025-10-07
**プロジェクト**: host-friendly-checkin
