#!/usr/bin/env python3
"""
ã‚¿ã‚¹ã‚¯å®Œäº†ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼ - CLI ãƒ„ãƒ¼ãƒ«

ãƒ¯ãƒ¼ã‚«ãƒ¼2ãŒã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«å‘¼ã³å‡ºã™ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«

ä½¿ç”¨ä¾‹:
  # ã‚³ãƒ¼ãƒ‰å¯©æŸ»ãŒæˆåŠŸï¼ˆå“è³ªã‚¹ã‚³ã‚¢ 0.92ã€å®Ÿè¡Œæ™‚é–“ 2.5ç§’ã€ã‚¹ã‚­ãƒ«: code_analysisï¼‰
  report-task-completion code_review success 0.92 2.5 code_analysis

  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—
  report-task-completion documentation failure 0.5 1.2 query_processing

  # è¤‡æ•°ã‚¹ã‚­ãƒ«
  report-task-completion refactoring success 0.88 5.0 "code_analysis,optimization"
"""

import sys
import os
from pathlib import Path

# ãƒ‘ã‚¹è¨­å®š
repo_root = Path(__file__).parent.parent
sys.path.insert(0, str(repo_root))
sys.path.insert(0, str(repo_root / "a2a_system"))

from a2a_system.skills.task_completion_hook import report_task_completion
from a2a_system.skills.common_utils import setup_logger

logger = setup_logger(__name__)


def parse_args():
    """ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ãƒ‘ãƒ¼ã‚¹"""
    if len(sys.argv) < 6:
        print("âŒ ä½¿ç”¨æ–¹æ³•:")
        print("")
        print("  report-task-completion <task_type> <result> <quality_score> <execution_time> <skills>")
        print("")
        print("å¼•æ•°:")
        print("  task_type       : ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ï¼ˆcode_review, documentationç­‰ï¼‰")
        print("  result          : çµæœï¼ˆsuccess / failureï¼‰")
        print("  quality_score   : å“è³ªã‚¹ã‚³ã‚¢ï¼ˆ0.0-1.0ï¼‰")
        print("  execution_time  : å®Ÿè¡Œæ™‚é–“ï¼ˆç§’ï¼‰")
        print("  skills          : ä½¿ç”¨ã‚¹ã‚­ãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰")
        print("")
        print("ä¾‹:")
        print("  report-task-completion code_review success 0.92 2.5 code_analysis")
        print("  report-task-completion documentation failure 0.5 1.2 query_processing")
        print("  report-task-completion refactoring success 0.88 5.0 \"code_analysis,optimization\"")
        print("")
        sys.exit(1)

    task_type = sys.argv[1]
    result = sys.argv[2].lower()
    quality_score = float(sys.argv[3])
    execution_time = float(sys.argv[4])
    skills_str = sys.argv[5]

    # result ã‚’ boolean ã«å¤‰æ›
    if result in ["success", "true", "yes", "1"]:
        success = True
    elif result in ["failure", "false", "no", "0"]:
        success = False
    else:
        print(f"âŒ result ã¯ 'success' ã¾ãŸã¯ 'failure' ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    # skills ã‚’ãƒªã‚¹ãƒˆã«å¤‰æ›
    skills = [s.strip() for s in skills_str.split(",") if s.strip()]

    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if quality_score < 0 or quality_score > 1:
        print(f"âŒ quality_score ã¯ 0.0-1.0 ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    if execution_time < 0:
        print(f"âŒ execution_time ã¯æ­£ã®æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    return task_type, success, quality_score, execution_time, skills


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    try:
        task_type, success, quality_score, execution_time, skills = parse_args()

        # ãƒ­ã‚°å‡ºåŠ›
        result_str = "âœ… æˆåŠŸ" if success else "âŒ å¤±æ•—"
        print("")
        print("=" * 60)
        print(f"ğŸ“‹ ã‚¿ã‚¹ã‚¯å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ")
        print("=" * 60)
        print(f"ã‚¿ã‚¹ã‚¯: {task_type}")
        print(f"çµæœ: {result_str}")
        print(f"å“è³ªã‚¹ã‚³ã‚¢: {quality_score}")
        print(f"å®Ÿè¡Œæ™‚é–“: {execution_time}ç§’")
        print(f"ä½¿ç”¨ã‚¹ã‚­ãƒ«: {', '.join(skills)}")
        print("=" * 60)
        print("")

        # ACE Learning Engine ã«å ±å‘Š
        print("ğŸ§  ACE Learning Engine ã«å ±å‘Šä¸­...")
        success_flag = report_task_completion(
            task_type=task_type,
            success=success,
            quality_score=quality_score,
            execution_time=execution_time,
            skills_used=skills
        )

        if success_flag:
            print("")
            print("âœ… ã‚¿ã‚¹ã‚¯å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆå®Œäº†")
            print("   Accumulate â†’ Refine â†’ Curate ã‚µã‚¤ã‚¯ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ")
            print("")
            sys.exit(0)
        else:
            print("")
            print("âŒ ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ")
            print("")
            sys.exit(1)

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
