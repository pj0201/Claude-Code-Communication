#!/bin/bash
# Claude Code ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’é–²è¦§ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•:
#   view-claude-logs                  # æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¡¨ç¤º
#   view-claude-logs list             # å…¨ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§è¡¨ç¤º
#   view-claude-logs [filename]       # æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º

set -euo pipefail

LOG_DIR="/home/planj/Claude-Code-Communication/logs"

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$LOG_DIR"

# ã‚³ãƒžãƒ³ãƒ‰åˆ¤å®š
COMMAND="${1:-view}"

case "$COMMAND" in
    list)
        echo "ðŸ“‹ Claude Code Session Logs:"
        echo ""
        if [ -z "$(ls -A "$LOG_DIR" 2>/dev/null)" ]; then
            echo "No logs found. Start capture with: capture-claude-logs &"
        else
            ls -lh "$LOG_DIR"/claude_code_session_*.log | awk '{print $9, "(" $5 ")"}'
        fi
        ;;
    tail)
        # æœ€æ–°ãƒ­ã‚°ã®æœ€å¾Œã®50è¡Œã‚’è¡¨ç¤º
        LATEST_LOG=$(ls -t "$LOG_DIR"/claude_code_session_*.log 2>/dev/null | head -1)
        if [ -z "$LATEST_LOG" ]; then
            echo "âŒ No logs found. Start capture with: capture-claude-logs &"
            exit 1
        fi
        echo "ðŸ“„ Latest log: $LATEST_LOG (last 50 lines)"
        echo ""
        tail -50 "$LATEST_LOG"
        ;;
    grep)
        # ãƒ­ã‚°ã‹ã‚‰æ¤œç´¢
        if [ -z "${2:-}" ]; then
            echo "Usage: view-claude-logs grep [search_term]"
            exit 1
        fi
        LATEST_LOG=$(ls -t "$LOG_DIR"/claude_code_session_*.log 2>/dev/null | head -1)
        if [ -z "$LATEST_LOG" ]; then
            echo "âŒ No logs found."
            exit 1
        fi
        echo "ðŸ” Searching for: $2"
        echo ""
        grep -n "$2" "$LATEST_LOG" || echo "No matches found"
        ;;
    *)
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æœ€æ–°ãƒ­ã‚°ã‚’less/moreã§è¡¨ç¤º
        LATEST_LOG=$(ls -t "$LOG_DIR"/claude_code_session_*.log 2>/dev/null | head -1)
        if [ -z "$LATEST_LOG" ]; then
            echo "âŒ No logs found. Start capture with: capture-claude-logs &"
            exit 1
        fi

        echo "ðŸ“„ Viewing: $LATEST_LOG"
        echo ""
        echo "Navigation:"
        echo "  Space: Next page"
        echo "  b: Previous page"
        echo "  /: Search"
        echo "  q: Quit"
        echo ""

        if command -v less &> /dev/null; then
            less +G "$LATEST_LOG"
        else
            more "$LATEST_LOG"
        fi
        ;;
esac
