#!/usr/bin/env python3
"""
ãƒãƒ¼ãƒ å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼

å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒè‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’ç°¡å˜ã«ãƒ¬ãƒãƒ¼ãƒˆã§ãã‚‹CLIãƒ„ãƒ¼ãƒ«

ä½¿ç”¨ä¾‹:
  # Worker3: ã‚³ãƒ¼ãƒ‰å®Ÿè£…å®Œäº†ï¼ˆæˆåŠŸï¼‰
  report-worker-task worker3 implementation success 0.92 2.5 "design_pattern,optimization"

  # GPT-5: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ï¼ˆæ¡ç”¨ç‡ 80%ï¼‰
  report-worker-task gpt5 code_review review 0.8 0.85 "naming,architecture"
"""

import sys
from pathlib import Path

# ãƒ‘ã‚¹è¨­å®š
repo_root = Path(__file__).parent.parent
sys.path.insert(0, str(repo_root))

from a2a_system.skills.team_knowledge_loop import TeamKnowledgeLoop
from a2a_system.skills.worker_task_classifier import WorkerType, WorkerTaskClassifier
from a2a_system.skills.common_utils import setup_logger

logger = setup_logger(__name__)


def parse_args():
    """ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ãƒ‘ãƒ¼ã‚¹"""
    if len(sys.argv) < 7:
        print_usage()
        sys.exit(1)

    worker_type = sys.argv[1].lower()
    task_type = sys.argv[2]
    result = sys.argv[3].lower()
    primary_score = float(sys.argv[4])
    secondary_score = float(sys.argv[5])
    skills_str = sys.argv[6]

    # worker_type ã‚’æ¤œè¨¼
    if worker_type not in ["worker3", "gpt5"]:
        print("âŒ worker_typeã¯ 'worker3' ã¾ãŸã¯ 'gpt5' ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    # result ã‚’ boolean ã«å¤‰æ›
    if result in ["success", "true", "yes", "1"]:
        success = True
    elif result in ["failure", "false", "no", "0"]:
        success = False
    else:
        print(f"âŒ resultã¯ 'success' ã¾ãŸã¯ 'failure' ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    # skills ã‚’ãƒªã‚¹ãƒˆã«å¤‰æ›
    skills = [s.strip() for s in skills_str.split(",") if s.strip()]

    # ã‚¹ã‚³ã‚¢ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if primary_score < 0 or primary_score > 1:
        print(f"âŒ primary_scoreã¯ 0.0-1.0 ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    if secondary_score < 0 or secondary_score > 1:
        print(f"âŒ secondary_scoreã¯ 0.0-1.0 ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„")
        sys.exit(1)

    return worker_type, task_type, success, primary_score, secondary_score, skills


def print_usage():
    """ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤º"""
    print("âŒ ä½¿ç”¨æ–¹æ³•:")
    print("")
    print("  report-worker-task <worker> <task> <result> <score1> <score2> <skills>")
    print("")
    print("Worker3ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼‰:")
    print("  report-worker-task worker3 implementation success 0.92 2.5 \"design_pattern,optimization\"")
    print("  å ±å‘Šå†…å®¹:")
    print("    - task: implementation (å®Ÿè£…), architecture_design (è¨­è¨ˆ), bug_fix (ãƒã‚°ä¿®æ­£),")
    print("            refactoring (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°), testing (ãƒ†ã‚¹ãƒˆ), performance_optimization")
    print("    - score1: å“è³ªã‚¹ã‚³ã‚¢ (0.0-1.0)")
    print("    - score2: å®Ÿè¡Œæ™‚é–“ (ç§’)")
    print("")
    print("GPT-5ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å£æ‰“ã¡ï¼‰:")
    print("  report-worker-task gpt5 code_review review 0.80 0.85 \"naming,architecture\"")
    print("  å ±å‘Šå†…å®¹:")
    print("    - task: code_review (ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼), architecture_review (è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼),")
    print("            technical_consultation (æŠ€è¡“ç›¸è«‡), problem_solving (å•é¡Œè§£æ±º),")
    print("            proposal_evaluation (ææ¡ˆè©•ä¾¡)")
    print("    - score1: æ¡ç”¨ç‡ (0.0-1.0)")
    print("    - score2: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å“è³ª (0.0-1.0)")
    print("")


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    try:
        worker_type, task_type, success, score1, score2, skills = parse_args()

        loop = TeamKnowledgeLoop()
        classifier = WorkerTaskClassifier()

        # ãƒ­ã‚°å‡ºåŠ›
        result_str = "âœ… æˆåŠŸ" if success else "âŒ å¤±æ•—"
        print("")
        print("=" * 60)
        print(f"ğŸ“‹ {classifier.get_worker_context_prefix(WorkerType(worker_type))} ã‚¿ã‚¹ã‚¯å ±å‘Š")
        print("=" * 60)
        print(f"ãƒ¯ãƒ¼ã‚«ãƒ¼: {worker_type}")
        print(f"ã‚¿ã‚¹ã‚¯: {classifier.get_task_description(task_type)}")
        print(f"çµæœ: {result_str}")
        print(f"ã‚¹ã‚³ã‚¢1: {score1}")
        print(f"ã‚¹ã‚³ã‚¢2: {score2}")
        print(f"ã‚¹ã‚­ãƒ«: {', '.join(skills)}")
        print("=" * 60)
        print("")

        # ãƒãƒ¼ãƒ å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã«å ±å‘Š
        if worker_type == "worker3":
            print("ğŸ’» Worker3ã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ãƒ å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã«å ±å‘Šä¸­...")
            success_flag = loop.record_worker3_task_completion(
                task_type=task_type,
                success=success,
                quality_score=score1,
                execution_time=score2,
                skills_used=skills
            )
        else:  # gpt5
            print("ğŸ” GPT-5ã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ãƒ å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã«å ±å‘Šä¸­...")
            success_flag = loop.record_gpt5_task_completion(
                task_type=task_type,
                success=success,
                adoption_rate=score1,
                feedback_quality=score2,
                insights=skills
            )

        if success_flag:
            print("")
            print("âœ… ã‚¿ã‚¹ã‚¯å ±å‘Šå®Œäº†")
            print("   ç›¸äº’å¼·åŒ–ãƒ«ãƒ¼ãƒ—ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ")
            print("   â†’ ãƒãƒ¼ãƒ å…¨ä½“ã®å­¦ç¿’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ã•ã‚Œã¾ã™")
            print("")
            sys.exit(0)
        else:
            print("")
            print("âŒ ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ")
            print("")
            sys.exit(1)

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
